
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Deploying-Python-code-to-servers">Deploying Python code to servers<a class="anchor-link" href="#Deploying-Python-code-to-servers">&#182;</a></h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<blockquote style="font-family: 'Times New Roman', serif; font-size: 20px; font-style: italic;"><span style="font-size: 4rem;">T</span>here are things that are hard, and then there's Python deployment. &mdash; me</blockquote>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>So you have some Python code that you would like to run on the web? This can become staggeringly more difficult than you might expect. First, let's be clear what we're talking about.</p>
<ul>
<li>deploy <em>desktop software</em> to users' computers and devices</li>
<li>deploy <em>server software</em> to a server, typically on cloud infrastructure like Amazon Web Services (AWS) or Google Cloud Platform, Heroku, PythonAnywhere and so on</li>
</ul>
<p>In this essay, we are focusing only on the second one, i.e., deployment of Python code to <strong>servers</strong>.</p>
<p>There <em>are</em> easy ways to do this: <a href="https://cloud.google.com/appengine/docs">Google App Engine</a> makes it almost completely painless, <strong>as long as</strong> you <a href="http://stackoverflow.com/a/24229338/170656">stick to Python 2.7</a> and <a href="https://cloud.google.com/appengine/docs/python/runtime#Python_Pure_Python">avoid packages with C-extensions</a></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>I'm kinda into <a href="http://cython.org/">Cython</a> so this is a problem for me, never mind the requirement for legacy Python. So what to do?</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Web-Hosts,-Web-Hosts-everywhere">Web Hosts, Web Hosts everywhere<a class="anchor-link" href="#Web-Hosts,-Web-Hosts-everywhere">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>There are many places to host Python code online. <a href="https://www.pythonanywhere.com/">PythonAnywhere</a> is a top-notch solution that makes it very, very easy to get going with your Python app, <strong>as long as</strong> your Python version is one of 2.6, 2.7, 3.3 and 3.4. Since there is shell access, you <em>can</em> also use virtualenv, but I'm grouping PythonAnywhere in the "does a lot for you" camp because they have a cool UI that simplifies much of the server administration tasks you would normally need to do from the shell.</p>
<p><a href="">Heroku</a> is the other popular choice, <strong>as long as</strong> the Python version you need happens to <a href="https://devcenter.heroku.com/articles/python-runtimes#supported-python-runtimes">match one of the two supported runtimes</a>.</p>
<p>Heroku does auto-scaling (just like App Engine), but with PythonAnywhere you just need to switch plans for more resources.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Moving-towards-server-administration-AKA-What-fresh,-new-hell-is-this?">Moving towards server administration AKA What fresh, new hell is this?<a class="anchor-link" href="#Moving-towards-server-administration-AKA-What-fresh,-new-hell-is-this?">&#182;</a></h2><p>If the restrictions are too much, you might have to set up your own server, like an Amazon EC2 instance, or a Rackspace/Linode server, and many others.  One of the best places to do that is <a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-ubuntu-cloud-servers-for-python-web-applications">DigitalOcean</a>, not least because their guides are <em>excellent</em>. The guides do also work well at other hosts though.</p>
<p>What you're pretty much doing at this point is taking on the role of a system administrator, likely <em>without any formal training</em>, and even more likely <strong>without an awareness of the Linux distribution life cycle and support practices</strong>, particularly if your development platform is OS X or Windows.  Unfortunately, it turns out that if you don't make an effort to understand those upstream issues, you subject yourself to surprising and painful experiences, like that time when <a href="https://bugs.launchpad.net/ubuntu/+source/python3.4/+bug/1503382">Ubuntu just downgraded its Python 3 package in the Long Term Support version, without fixing packages that depended on that version leaving my docker deployment in a broken state</a>. (I <em>chose</em> the LTS specifically to avoid things like that!)  Don't worry, eventually it all got fixed a few weeks later.</p>
<p>But let's get back to the deployment of Python apps.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Patterns,-Anti-patterns---Can-you-tell-the-difference?">Patterns, Anti-patterns - Can you tell the difference?<a class="anchor-link" href="#Patterns,-Anti-patterns---Can-you-tell-the-difference?">&#182;</a></h2><p>If you sink a lot of time into reading blogs and StackOverflow, there is much wisdom to be found. <a href="https://hynek.me/articles/python-deployment-anti-patterns/">Hynek</a> made an excellent post about deployment anti-patterns to avoid.</p>
<p><a href="http://blog.dscpl.com.au/2016/01/python-virtual-environments-and-docker.html">Graham Dumpleton</a> has an extensive blog series going about deploying your Python code in Docker containers, and the nature of the content is very much a collection of good patterns, and anti-patterns to avoid.  I've read them several times, and still don't quite get everything, especially with respect to Docker, but I <em>feel</em> like if just read through it one more time, all will become clear :/</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="...which-brings-us-to-Docker">...which brings us to Docker<a class="anchor-link" href="#...which-brings-us-to-Docker">&#182;</a></h1><p>In case you don't know, <code>Docker</code> is a very clever tool that makes it easy for you run virtual machines. The docker people don't like to hear that, but honestly it's the easiest mental picture until you need to care about the details.  The easiness has direct implications for two things:</p>
<ul>
<li>Easy to set up locally, to make development easier</li>
<li>Easy to re-create the virtual machine on a production server, making deployment easier</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="You-still-have-to-do-system-administration!--Docker-doesn't-solve-this!">You still have to do system administration!  Docker doesn't solve this!<a class="anchor-link" href="#You-still-have-to-do-system-administration!--Docker-doesn't-solve-this!">&#182;</a></h3><p>You <em>still</em> have to do system administration; <code>docker</code> just makes it easy to work with a "known" configuration.  This means that it doesn't matter whether your project runs on Amazon Web Services, or Openshift, or Google Cloud Platform: you can deploy the same docker image to all of them.</p>
<p>However, <strong>this doesn't solve all our problems</strong>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="What-are-our-problems?">What are our problems?<a class="anchor-link" href="#What-are-our-problems?">&#182;</a></h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Imagine the following:</p>
<ul>
<li>We want to deploy a service onto a single server</li>
<li>This service uses several different applications locally.  </li>
<li>Each application is a Python application</li>
<li>Each Python application uses one or more versions of <strong>Python</strong></li>
<li>Each Python application uses a different set of packages, each pinned themselves to different versions</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The tricky part is <em>one or more versions of Python</em>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Different-Versions-of-Python">Different Versions of Python<a class="anchor-link" href="#Different-Versions-of-Python">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Linux distros tend to be slow-moving, for the obvious reason that updating packages requires an enormous coordination effort to make sure that upgrading one thing doesn't break other things.  Unfortunately, this means that it can be difficult to use version of software, say, Python, that are not the <em>official packaged versions</em> of the Linux distribution you're targetting.</p>
<p>However, this <em>isn't the actual problem</em>.  It doesn't matter how fast the distro moves.  The issue is really about being able to pin software versions to a specific version that you choose.  And only upgrade <em>when</em> you want.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="About-virtualenv---version-pinning">About virtualenv - version pinning<a class="anchor-link" href="#About-virtualenv---version-pinning">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>virtualenv</code> isolates different Python applications' dependecies from each other.  For example, suppose you have one Python application that needs Numpy 1.7.1 and a different Python application that needs Numpy 1.8. <code>virtualenv</code> will allow you to install and run both Python applications on the same machine.  However, you are still restricted by the Python interpreter running on that machine.  On most Linux distributions (at the time of writing), you can install Python 2.7 and Python 3.4, but not 3.5.</p>
<p>Assuming you installed both 2.7 and 3.4, you could make virtualenvs of either of them, but you <strong>cannot make a virtualenv for 3.5</strong>.  Virtualenv doesn't work like that.</p>
<p>In the future, popular linux distributions will likely upgrade 3.4 to 3.5.  <strong>This does not solve our problems</strong>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Version-pinning---also-for-Python-itself">Version pinning - also for Python itself<a class="anchor-link" href="#Version-pinning---also-for-Python-itself">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The entire point of using virtualenv in the first place, is to allow us to pin our app dependencies and isolate the <strong>version</strong> requirements of different apps from each other. What we <em>really</em> want, is to have version-pinning <strong>also for Python itself</strong>.</p>
<p>Let's imagine we have two Python apps, <code>alpha</code> and <code>beta</code>.  The first, <code>alpha</code> was written against 2.7, while the second, <code>beta</code> was written against 3.4.  Because they used different versions of Python, <em>strictly speaking</em> we don't need to use virtualenv, but because we fear the wrath of Hynek we did it anyway.</p>
<p>It was just as well: six months down the road, a new app is deployed to the same server, <code>gamma</code>, which also runs on 3.4, but which uses different versions of some of the app dependencies.  For example, suppose <code>beta</code> uses Numpy 1.7.1 while <code>gamma</code> uses Numpy 1.8.  Virtualenv allows us to keep <code>beta</code> and <code>gamma</code> running on their own dependencies, even though they are both using 3.4</p>
<p><em>Now</em> suppose that we deploy a new app, <code>delta</code> to the same server, but that app needs to run on Python 3.5!  What we <strong>don't want to do</strong> is have to upgrade <code>beta</code> and <code>gamma</code> also to 3.5.  For one thing, there may be some packages that are dependencies of <code>beta</code> and <code>gamma</code> that have not yet been made available for 3.5.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="How-to-do-version-pinning-for-Python-itself">How to do version pinning for <u>Python</u> itself<a class="anchor-link" href="#How-to-do-version-pinning-for-Python-itself">&#182;</a></h1><p>Right now, as far as I am aware there are two main routes:</p>
<ol>
<li><a href="http://conda.pydata.org/docs/">Conda</a></li>
<li><a href="https://github.com/yyuu/pyenv">pyenv</a></li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>There is another route, called <em>Compiling Python from source yourself</em> which I won't go into here.  If you're going to do it all by hand then you will inevitably have to start building the same kinds of tools that the other routes already provide.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Conda">Conda<a class="anchor-link" href="#Conda">&#182;</a></h2><p>Conda is a tool that you normally obtain from, and use with the <a href="https://www.continuum.io/downloads">Anaconda Python</a> distribution from Continuum Analytics.  <strong><code>conda</code> is both a package manager and a virtual environment manager</strong>.  This means that not only do you install Python packages with it, but you can also create new Python virtual environments, just like virtualenv. There are other features of the conda ecosystem, such as the support for built (compiled) packages so that you don't need to compile packages yourself like you would have to do with <code>pip</code>.</p>
<p>(You <em>can</em> install built packages with <code>pip</code> if there is a <code>wheel</code> available for that package, however not all packages provide wheels.  With <code>conda</code> almost all the popular packages are available in a pre-compiled, or "built", format.)</p>
<p>What we are interested in is the support for virtual environments.  Using <code>conda</code> you can install and activate different versions of Python from 2.6 to 3.5, <em>and</em> you can create multiple virtual environments off each of those.</p>
<p>One of the niggles with using <code>conda</code> is that <strong>not all Python packages</strong> are available in the special <code>conda</code> repository; <code>conda</code> does not install from the Python Package Index, but rather its own repository that is maintained by Continuum Analytics.  The fallback, in such situations, is to use <code>pip</code> from inside the <code>conda</code> virtual environment and install extra packages that way. Now you have to deal with a chimeric environment where there are two package managers competing for control (within that environment).  They <em>mostly</em> get along when you're running all the commands manually, but we're interested in <strong>servers</strong> and <strong>automated deployment</strong>.</p>
<p>Which one must use <code>requirements.txt</code>?  <code>conda</code> or <code>pip</code>?  This difficult question, and similar issues, is why I generally don't deploy to servers using <code>conda</code>.  It makes things more complicated, including the explanations you have to give to other devs on the project about what <code>conda</code> even is.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="pyenv">pyenv<a class="anchor-link" href="#pyenv">&#182;</a></h2><p>Pyenv is an <em>even more clever hack</em> than what <code>virtualenv</code> does, and <code>pyenv</code> is really closer to what <code>conda</code> is doing for virtual environments.  Note that <code>pyenv</code> is not a package manager though: it only deals with Python environments, which means you would still use <code>pip</code> for installing packages.  Also, <code>pyenv</code> is not a replacement for <code>virtualenv</code> (which makes <em>virtual</em> Python environments), but it can work with <code>virtualenv</code>.  Confused yet?</p>
<p>Pyenv is a tool for installing multiple different Python versions, including not only the official CPython releases, but even PyPy versions and even <a href="http://stackless.readthedocs.org/en/latest/stackless-python.html">Stackless Python</a>.</p>
<p>Unfortunately, <code>pyenv</code> does not work on Windows (<code>conda</code> does).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Bring-on-the-pain-AKA-a-demonstration-with-pyenv-and-Docker">Bring on the pain AKA a demonstration with pyenv and Docker<a class="anchor-link" href="#Bring-on-the-pain-AKA-a-demonstration-with-pyenv-and-Docker">&#182;</a></h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Docker">Docker<a class="anchor-link" href="#Docker">&#182;</a></h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Getting docker set up is well beyond the scope of this post.  I'm using docker only as a very simple way to start a VM with the Centos Linux distribution. (Perhaps I should make another blog post called "Docker for ordinary devs"...)</p>
<p>You don't need to use docker for this.  You can also just start a VM using VMware or Virtualbox.  However, to get going with docker, once it is set up, is quite easy:</p>
<div class="highlight"><pre>docker run -i -t centos:7.2.1511 /bin/bash
</pre></div>
<p>And then you'll see the prompt change to something like this:</p>
<div class="highlight"><pre><span class="o">[</span>root@7bc15f9e0045 /<span class="o">]</span><span class="c1">#</span>
</pre></div>
<p>In the following steps, I change the prompt to <code>$</code> to keep it simpler (and more general).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Setting-up-pyenv">Setting up <code>pyenv</code><a class="anchor-link" href="#Setting-up-pyenv">&#182;</a></h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Install the development tools (this is specific to the Centos and Red Hat distributions of Linux):</p>
<div class="highlight"><pre>$ yum groupinstall <span class="s1">&#39;Development Tools&#39;</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Certain libraries are needed to build Python, which we are going to do a bunch of times:</p>
<div class="highlight"><pre>$ yum install zlib-devel bzip2 bzip2-devel readline-devel sqlite sqlite-devel openssl-devel
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Make a folder for the upcoming pydev installer:</p>
<div class="highlight"><pre>$ mkdir pyenv
$ <span class="nb">cd</span> pyenv
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Obtain the pyenv installer (copied from the pyenv docs):</p>
<div class="highlight"><pre>$ curl -L https://raw.githubusercontent.com/yyuu/pyenv-installer/master/bin/pyenv-installer <span class="p">|</span> bash
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This will fail because you also need <code>git</code>:</p>

<pre><code>$ yum install git</code></pre>
<p>Now do the <code>curl</code> command again.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Need to add some things to your bash profile:</p>

<pre><code>$ echo 'export PYENV_ROOT="$HOME/.pyenv"' &gt;&gt; ~/.bash_profile
$ echo 'export PATH="$PYENV_ROOT/bin:$PATH"' &gt;&gt; ~/.bash_profile</code></pre>
<p>and</p>
<div class="highlight"><pre>$ <span class="nb">echo</span> <span class="s1">&#39;eval &quot;$(pyenv init -)&quot;&#39;</span> &gt;&gt; ~/.bash_profile
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now re-read your <code>bash</code> config file to set up pyenv:</p>
<div class="highlight"><pre>$ <span class="nb">source</span> ~/.bash_profile
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Install a Python version:</p>

<pre><code>$ pyenv install 2.7.11</code></pre>
<p>Note that this doesn't automatically "activate" or do anything with the new Python, it just installs it. You can check to see which Python is currently active:</p>
<div class="highlight"><pre>$ pyenv version
system <span class="o">(</span><span class="nb">set</span> by /root/.pyenv/version<span class="o">)</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You can set up things so that a specific Python version is associated with a <strong>particular directory</strong>.  This is called the <strong><code>local</code></strong> setting.  You can also change out the <strong><code>global</code></strong> python interpreter using the subcommand of the same name. Lastly, you can change the <strong><code>shell</code></strong> interpreter.  Let's do that by changing from the default to the one we just installed.</p>
<div class="highlight"><pre>$ pyenv versions
* system <span class="o">(</span><span class="nb">set</span> by /root/.pyenv/version<span class="o">)</span>
  2.7.11
$ python -V
Python 2.7.5
$ pyenv shell 2.7.11
$ python -V
Python 2.7.11
</pre></div>
<p>The <code>2.7.5</code> is the default Python installed on this version of Centos, 7.2.1511.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's add another Python:</p>
<div class="highlight"><pre>$ pyenv install 3.5.1
sha256sum: the --quiet option is meaningful only when verifying checksums
Try <span class="s1">&#39;sha256sum --help&#39;</span> <span class="k">for</span> more information.
Downloading Python-3.5.1.tgz...
-&gt; https://www.python.org/ftp/python/3.5.1/Python-3.5.1.tgz
Installing Python-3.5.1...
Installed Python-3.5.1 to /root/.pyenv/versions/3.5.1
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Listing out the versions shows that 3.5.1 is now available:</p>
<div class="highlight"><pre>$ pyenv versions
  system
* 2.7.11 <span class="o">(</span><span class="nb">set</span> by PYENV_VERSION environment variable<span class="o">)</span>
  3.5.1
</pre></div>
<p>It's also pretty great how the feedback tells us that the currently active one was set for the shell.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>So now we have decoupled Python versions from the operating system. In fact we can now install <strong>any of these Python versions</strong> in this incredibly long list (apologies for the length; just scroll past it if you like):</p>

<pre><code>$ pyenv install --list
Available versions:
  2.1.3
  2.2.3
  2.3.7
  2.4
  2.4.1
  2.4.2
  2.4.3
  2.4.4
  2.4.5
  2.4.6
  2.5
  2.5.1
  2.5.2
  2.5.3
  2.5.4
  2.5.5
  2.5.6
  2.6.6
  2.6.7
  2.6.8
  2.6.9
  2.7-dev
  2.7
  2.7.1
  2.7.2
  2.7.3
  2.7.4
  2.7.5
  2.7.6
  2.7.7
  2.7.8
  2.7.9
  2.7.10
  2.7.11
  3.0.1
  3.1
  3.1.1
  3.1.2
  3.1.3
  3.1.4
  3.1.5
  3.2-dev
  3.2
  3.2.1
  3.2.2
  3.2.3
  3.2.4
  3.2.5
  3.2.6
  3.3.0
  3.3-dev
  3.3.1
  3.3.2
  3.3.3
  3.3.4
  3.3.5
  3.3.6
  3.4.0
  3.4-dev
  3.4.1
  3.4.2
  3.4.3
  3.4.4
  3.5.0
  3.5-dev
  3.5.1
  3.6-dev
  anaconda-1.4.0
  anaconda-1.5.0
  anaconda-1.5.1
  anaconda-1.6.0
  anaconda-1.6.1
  anaconda-1.7.0
  anaconda-1.8.0
  anaconda-1.9.0
  anaconda-1.9.1
  anaconda-1.9.2
  anaconda-2.0.0
  anaconda-2.0.1
  anaconda-2.1.0
  anaconda-2.2.0
  anaconda-2.3.0
  anaconda-2.4.0
  anaconda2-2.4.0
  anaconda2-2.4.1
  anaconda3-2.0.0
  anaconda3-2.0.1
  anaconda3-2.1.0
  anaconda3-2.2.0
  anaconda3-2.3.0
  anaconda3-2.4.0
  anaconda3-2.4.1
  ironpython-dev
  ironpython-2.7.4
  ironpython-2.7.5
  jython-dev
  jython-2.5.0
  jython-2.5-dev
  jython-2.5.1
  jython-2.5.2
  jython-2.5.3
  jython-2.5.4-rc1
  jython-2.7.0
  jython-2.7.1b1
  jython-2.7.1b2
  miniconda-latest
  miniconda-2.2.2
  miniconda-3.0.0
  miniconda-3.0.4
  miniconda-3.0.5
  miniconda-3.3.0
  miniconda-3.4.2
  miniconda-3.7.0
  miniconda-3.8.3
  miniconda-3.9.1
  miniconda-3.10.1
  miniconda-3.16.0
  miniconda-3.18.3
  miniconda2-latest
  miniconda2-3.18.3
  miniconda2-3.19.0
  miniconda3-latest
  miniconda3-2.2.2
  miniconda3-3.0.0
  miniconda3-3.0.4
  miniconda3-3.0.5
  miniconda3-3.3.0
  miniconda3-3.4.2
  miniconda3-3.7.0
  miniconda3-3.8.3
  miniconda3-3.9.1
  miniconda3-3.10.1
  miniconda3-3.16.0
  miniconda3-3.18.3
  miniconda3-3.19.0
  pypy-c-jit-latest
  pypy-c-nojit-latest
  pypy-dev
  pypy-stm-2.3
  pypy-portable-2.3.1
  pypy-portable-2.4
  pypy-portable-2.5
  pypy-portable-2.5.1
  pypy-stm-2.5.1
  pypy-portable-2.6
  pypy-portable-2.6.1
  pypy-portable-4.0
  pypy-portable-4.0.1
  pypy-1.5-src
  pypy-1.5
  pypy-1.6
  pypy-1.7-dev
  pypy-1.7
  pypy-1.8-dev
  pypy-1.8
  pypy-1.9-dev
  pypy-1.9
  pypy-2.0-dev
  pypy-2.0-src
  pypy-2.0
  pypy-2.0.1-src
  pypy-2.0.1
  pypy-2.0.2-src
  pypy-2.0.2
  pypy-2.1-src
  pypy-2.1
  pypy-2.2-src
  pypy-2.2
  pypy-2.2.1-src
  pypy-2.2.1
  pypy-2.3-src
  pypy-2.3
  pypy-2.3.1-src
  pypy-2.3.1
  pypy-2.4.0-src
  pypy-2.4.0
  pypy-2.4-beta1-src
  pypy-2.4-beta1
  pypy-2.5.0-src
  pypy-2.5.0
  pypy-2.5.1-src
  pypy-2.5.1
  pypy-2.6.0-src
  pypy-2.6.0
  pypy-2.6.1-src
  pypy-2.6.1
  pypy-4.0.0-src
  pypy-4.0.0
  pypy-4.0.1-src
  pypy-4.0.1
  pypy3-dev
  pypy3-portable-2.3.1
  pypy3-portable-2.4
  pypy3-2.3.1-src
  pypy3-2.3.1
  pypy3-2.4.0-src
  pypy3-2.4.0
  stackless-dev
  stackless-2.7-dev
  stackless-2.7.2
  stackless-2.7.3
  stackless-2.7.4
  stackless-2.7.5
  stackless-2.7.6
  stackless-2.7.7
  stackless-2.7.8
  stackless-3.2-dev
  stackless-3.2.2
  stackless-3.2.5
  stackless-3.3-dev
  stackless-3.3.5
  stackless-3.4.1</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>However, we <strong>still have a problem</strong> because different Python apps using the <strong>same version of Python</strong> still need version pinning for their respective dependencies.  Remember the example of one app needing Numpy 1.7.1 and the other needing Numpy 1.8?</p>
<p>This is what <strong>virtualenv</strong> is for, and you can also use it with <code>pyenv</code>:</p>
<div class="highlight"><pre>$ pyenv versions
  system
* 2.7.11 <span class="o">(</span><span class="nb">set</span> by PYENV_VERSION environment variable<span class="o">)</span>
  3.5.1
</pre></div>
<p>Now lets create a new <code>virtualenv</code> for the 3.5.1 version of Python:</p>
<div class="highlight"><pre>$ pyenv virtualenv 3.5.1 my_env_35
Ignoring indexes: https://pypi.python.org/simple
Requirement already satisfied <span class="o">(</span>use --upgrade to upgrade<span class="o">)</span>: setuptools in /root/.pyenv/versions/3.5.1/envs/my_env_35/lib/python3.5/site-packages
Requirement already satisfied <span class="o">(</span>use --upgrade to upgrade<span class="o">)</span>: pip in /root/.pyenv/versions/3.5.1/envs/my_env_35/lib/python3.5/site-packages
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Listing out the available versions again:</p>
<div class="highlight"><pre>pyenv versions
  system
* 2.7.11 <span class="o">(</span><span class="nb">set</span> by PYENV_VERSION environment variable<span class="o">)</span>
  3.5.1
  3.5.1/envs/my_env_35
  my_env_35
</pre></div>
<p>The virtualenv is listed separately, and twice.  I don't know why.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You can activate the new virtualenv in two ways:</p>
<div class="highlight"><pre>$ pyenv shell my_env_35
pyenv-virtualenv: deactivate
pyenv-virtualenv: activate my_env_35
pyenv-virtualenv: prompt changing will be removed from future release. configure <span class="sb">`</span><span class="nb">export</span> <span class="nv">PYENV_VIRTUALENV_DISABLE_PROMPT</span><span class="o">=</span>1<span class="err">&#39;</span> to simulate the behavior.
<span class="o">(</span>my_env_35<span class="o">)</span> $ python -V
Python 3.5.1
</pre></div>
<p>This method treats the virtualenv like just another Python instance, which is nice. To do the deactivation, just switch to another Python version:</p>
<div class="highlight"><pre>$ pyenv shell system
pyenv-virtualenv: deactivate 3.5.1/envs/my_env_35
$ python -V
Python 2.7.5
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The other way is to use <code>pyenv activate &lt;envname&gt;</code> and <code>pyenv deactivate</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Running-your-app">Running your app<a class="anchor-link" href="#Running-your-app">&#182;</a></h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The easiest way is probably to create a short <a href="http://stackoverflow.com/a/30222231/170656">wrapper shell script</a> to change to the correct env, and then call your app:</p>
<div class="highlight"><pre><span class="c1"># run.sh</span>
pyenv shell 3.5.1
python myapp.py
</pre></div>
<p>And then the way you start your app becomes:</p>
<div class="highlight"><pre>$ <span class="nb">source</span> run.sh
</pre></div>
<p>(You can also put a bash shebang at the top of <code>run.sh</code> and make it executable, in the usual way.)</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If you have multiple apps, this becomes tedious, so rather just have a single runner, and pass it args:</p>
<div class="highlight"><pre><span class="c1"># run.sh</span>
pyenv shell 3.5.1
python <span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
</pre></div>
<p>The <code>"$@"</code> arguments is special (and <a href="http://stackoverflow.com/a/3816747/170656">make sure you include the quotes</a>). It makes sure all the arguments passed to your <code>run.sh</code> script will get passed on.  So now the name of your Python app becomes an argument to run.sh:</p>
<div class="highlight"><pre>$ <span class="nb">source</span> run.sh myapp.py
<span class="o">(</span>myapp.py runs under 3.5.1<span class="o">)</span>
$ <span class="nb">source</span> run.sh myotherapp.py
<span class="o">(</span>myotherapp.py also runs 3.5.1<span class="o">)</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If you're still paying attention and have not been completely exhausted yet, it should be easy to see how you might generalize <code>run.sh</code> so that you can also pass the name of the Python environment to use. However, it begins to get a bit fiddly with managing the list of command-line parameters if some of them (e.g. "3.5.1") are not meant for the python script, but you still want to pass everything <em>else</em> to your app.</p>
<p>In this case, it will be much easier to simply set an environment variable.</p>
<h3 id="In-fact,-pyenv-already-provides-this-by-default">In fact, <code>pyenv</code> already provides this by default<a class="anchor-link" href="#In-fact,-pyenv-already-provides-this-by-default">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You don't even need to muck around with a shell script at all.  To have exactly the same effect as running <code>pyenv shell 3.5.1</code>, all you need is this:</p>
<div class="highlight"><pre>$ <span class="nv">PYENV_VERSION</span><span class="o">=</span>my_env_35 python myapp.py
<span class="o">(</span>myapp.py runs under the virtualenv<span class="o">)</span>
$ <span class="nv">PYENV_VERSION</span><span class="o">=</span>system python myapp.py
<span class="o">(</span>myapp.py runs under the system python<span class="o">)</span>
$ <span class="nv">PYENV_VERSION</span><span class="o">=</span>2.7.11 python myapp.py
<span class="o">(</span>myapp.py runs under Python 2.7.11<span class="o">)</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre> 
</pre></div>

</div>
</div>
</div>

</div>